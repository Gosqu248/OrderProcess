<!-- src/main/resources/static/index.html -->
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Znajdź Restaurację</title>
</head>
<body>
<div class="container">
    <h1>Nie wiesz co dziś zjeść?</h1>
    <p>Wpisz adres, znajdź interesującą Cię restaurację i zamów jedzenie na które masz ochotę</p>
    <input type="text" placeholder="Wpisz adres" id="address">
    <button type="button" onclick="searchRestaurants()">Znajdź Restaurację</button>
</div>
<script>
    let processInstanceKey;

    // Call /start endpoint when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            processInstanceKey = data.processInstanceKey;
            sessionStorage.setItem('processInstanceKey', processInstanceKey);
        })
        .catch(error => {
            console.error('Error starting process:', error);
        });
    });

    function searchRestaurants() {
        const address = document.getElementById('address').value.trim();

        if (!address) {
            alert('Proszę wpisać adres.');
            return;
        }

        // Call enterAddress endpoint
        fetch(`/tasks/${processInstanceKey}/enterAddress`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ address: address })
        })
        .then(response => response.json())
        .then(() => {
            return fetch(`http://localhost:8080/api/restaurantAddress/searchRestaurant?address=${address}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                localStorage.setItem('foundRestaurants', JSON.stringify(data));
                window.location.href = `restaurants.html?address=${encodeURIComponent(address)}`;
            } else {
                alert('Nie znaleziono restauracji.');
            }
        })
        .catch(error => {
            console.error('Error searching restaurants:', error);
            alert('Wystąpił błąd podczas wyszukiwania restauracji.');
        });
    }
</script>
</body>
</html>